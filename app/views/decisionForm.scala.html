@(d: Decision, isNew: Boolean, choices: Seq[DecisionAlternative])

@import helpers._
@import com.decision_hub.Util._

  <h2>Create (or edit) Decision</h2>


    @if(! isNew) {
      <input type='hidden' name='id' value='@d.id'>
    }

    <fieldset>
      <form id='createOrEditDecisionForm' class="form-horizontal">

        @bootstrapField("Title") {
          <input name='title' type="text" value="@d.title.encodedAsJavascript"/>
        }
  
        @bootstrapField("In one phrase") { 
          <input name='punchLine' type="text" value="@d.punchLine.map(_.encodedAsJavascript).getOrElse("")"/>
        }
  
        @bootstrapField("Description") {
          <textarea name='summary' class='input-xlarge' type="textarea" value="@d.summary.map(_.encodedAsJavascript).getOrElse("")"/>
        }
  
        @bootstrapField("Election ends") {
          <label class="radio">
            <input type="radio" name="endMode" value="complete" checked>
            when every one has voted
          </label>
          <label class="radio">
            <input type="radio" name="endMode" value="time">
            on @dateTimeField(None, "endDate", "endHour", "endMinute")
          </label>
        }
  
        @bootstrapField("Results are shown only at the end") {
          <input type="checkbox" name='resultsPrivateUntilEnd' value='true' @(if(d.resultsPrivateUntilEnd) "checked" else "")/>
        }

      </form>

          @bootstrapField("Choices") {
            <ul id='alternatives'></ul>
            <a onClick="addEmptyAlt()" class='btn btn-primary'>Add Choice</a>
          }

    </fieldset>


  <a class='btn  btn-primary' data-dismiss="modal" onClick='submitNewDecision()'>Save</a>
  <a class='btn' data-dismiss="modal" >Cancel</a>



<script>

  // ids of new choices will be negative
  var i = 0
  var persistedChoicesToDelete = new Array(0);

  function removeAlt(idx) {
    if(idx >= 0)
      persistedChoicesToDelete.push(idx)
  }

  function addEmptyAlt() {
    i--
    addAlt(i,'')
  }

  function addAlt(i, txt) {
    $('#alternatives').append(
      $('<li/>').append(
        $('<form>').append(
          $('<input/>', {name:'title', type:'text', value:txt})
        ).append(
          $('<input/>', {name:'id', type:'hidden', value:i})
        ).append(
          $("<a/>", {
            class:   "btn btn-primary",
            text:    "remove"
          }).click(function() {
            removeAlt(i)
            $(this).parent().parent().remove()
          })
        )
      )
    )
  }

  @if(choices.size == 0) {
    addEmptyAlt()
  } else {
    @for(c <- choices) {
      addAlt(@c.id,'@c.title.encodedAsJavascript')
    }
  }

  $.fn.serializeObject = function() {
    var o = {};
    var a = this.serializeArray();
    $.each(a, function() {
      if (o[this.name] !== undefined) {
        if (!o[this.name].push) {
            o[this.name] = [o[this.name]];
        }
        o[this.name].push(this.value || '');
      } else {
        o[this.name] = this.value || '';
      }
    });
    return o;
  }

  $('#endDate').datepicker().datepicker("setDate", new Date(@(System.currentTimeMillis)));
  
  function submitNewDecision() {

    var d = $('#endDate').datepicker('getDate').getTime()
    var formFields = $("#createOrEditDecisionForm").serializeObject()
    formFields.endDate = d

    formFields.choicesToDelete = persistedChoicesToDelete

    var choiceForms = 
      $('#alternatives form').map(function() {
        return $(this).serializeObject()
      }).get()

    formFields.alternativePosts = choiceForms
    //alert(":->" +JSON.stringify(choiceForms))

    var z = JSON.stringify(formFields)

    $.ajax({
      type: 'POST',
      url: "/decision/create",
      data: z,
      success: function() {},
      contentType: "application/json; charset=utf-8",
      dataType: 'json'
    })
  }

</script>
